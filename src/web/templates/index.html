<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cluster Health Monitor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .breadcrumb {
            margin-bottom: 20px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .breadcrumb span {
            color: #666;
            margin: 0 8px;
        }

        /* Cluster List View */
        .cluster-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .cluster-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .cluster-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 12px rgba(0,0,0,0.15);
        }

        .cluster-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .status-indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 12px;
            animation: pulse 2s infinite;
        }

        .status-green { background-color: #10b981; }
        .status-yellow { background-color: #f59e0b; }
        .status-red { background-color: #ef4444; }
        .status-gray { background-color: #9ca3af; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .cluster-name {
            font-size: 18px;
            font-weight: 600;
        }

        .cluster-description {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .cluster-stats {
            display: flex;
            gap: 15px;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
        }

        /* Node List View */
        .node-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .node-card {
            background: white;
            border-radius: 10px;
            padding: 16px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .node-card:hover {
            transform: translateY(-2px);
        }

        .node-header {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .node-name {
            font-size: 16px;
            font-weight: 600;
        }

        .node-type {
            font-size: 12px;
            color: #666;
            background: #f0f0f0;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: auto;
        }

        .node-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .metric-item {
            background: #f9f9f9;
            padding: 8px;
            border-radius: 6px;
        }

        .metric-name {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }

        .metric-value {
            font-size: 18px;
            font-weight: 600;
        }

        /* Node Detail View */
        .node-detail {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .node-info {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .info-item {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 8px;
        }

        .info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 16px;
            font-weight: 600;
        }

        .metric-selector {
            margin-bottom: 16px;
        }

        .metric-selector select {
            padding: 8px 16px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
        }

        .chart-container {
            position: relative;
            height: 400px;
            background: white;
            border-radius: 8px;
            padding: 16px;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: #666;
        }

        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 16px;
        }

        .refresh-btn:hover {
            background: #5a67d8;
        }

        .time-range-selector {
            display: inline-block;
            margin-left: 16px;
        }

        .time-range-selector select {
            padding: 8px 16px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Cluster Health Monitor</h1>
    </div>

    <div class="container">
        <div class="breadcrumb" id="breadcrumb">
            <a href="#" onclick="showClusters()">Clusters</a>
        </div>

        <div id="content">
            <div class="loading">Loading...</div>
        </div>
    </div>

    <script>
        let currentView = 'clusters';
        let currentCluster = null;
        let currentNode = null;
        let chart = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            showClusters();
        });

        // Show cluster list
        async function showClusters() {
            currentView = 'clusters';
            currentCluster = null;
            currentNode = null;
            updateBreadcrumb();

            const content = document.getElementById('content');
            content.innerHTML = '<div class="loading">Loading clusters...</div>';

            try {
                const response = await fetch('/api/clusters');
                const clusters = await response.json();

                if (clusters.length === 0) {
                    content.innerHTML = '<div class="error-message">No clusters found. Please check your configuration.</div>';
                    return;
                }

                let html = '<div class="cluster-grid">';
                for (const cluster of clusters) {
                    html += `
                        <div class="cluster-card" onclick="showCluster('${cluster.name}')">
                            <div class="cluster-header">
                                <div class="status-indicator status-${cluster.status_color}"></div>
                                <span class="cluster-name">${cluster.name}</span>
                            </div>
                            <div class="cluster-description">${cluster.description || 'No description'}</div>
                            <div class="cluster-stats">
                                <div class="stat">
                                    <div class="stat-value">${cluster.node_count}</div>
                                    <div class="stat-label">Total Nodes</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value" style="color: #10b981">${cluster.healthy_nodes}</div>
                                    <div class="stat-label">Healthy</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value" style="color: #f59e0b">${cluster.warning_nodes}</div>
                                    <div class="stat-label">Warning</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value" style="color: #ef4444">${cluster.critical_nodes}</div>
                                    <div class="stat-label">Critical</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                html += '</div>';
                content.innerHTML = html;
            } catch (error) {
                content.innerHTML = `<div class="error-message">Failed to load clusters: ${error.message}</div>`;
            }
        }

        // Show nodes in a cluster
        async function showCluster(clusterName) {
            currentView = 'cluster';
            currentCluster = clusterName;
            currentNode = null;
            updateBreadcrumb();

            const content = document.getElementById('content');
            content.innerHTML = '<div class="loading">Loading nodes...</div>';

            try {
                const response = await fetch(`/api/clusters/${clusterName}`);
                const cluster = await response.json();

                if (cluster.error) {
                    content.innerHTML = `<div class="error-message">${cluster.error}</div>`;
                    return;
                }

                let html = `<h2 style="margin-bottom: 20px">${cluster.name} - ${cluster.description || 'No description'}</h2>`;
                html += '<div class="node-grid">';
                
                for (const node of cluster.nodes) {
                    html += `
                        <div class="node-card" onclick="showNode('${clusterName}', '${node.name}')">
                            <div class="node-header">
                                <div class="status-indicator status-${node.status_color}"></div>
                                <span class="node-name">${node.name}</span>
                                <span class="node-type">${node.type}</span>
                            </div>
                            <div class="node-metrics">
                                ${formatNodeMetrics(node.metrics)}
                            </div>
                        </div>
                    `;
                }
                html += '</div>';
                content.innerHTML = html;
            } catch (error) {
                content.innerHTML = `<div class="error-message">Failed to load cluster: ${error.message}</div>`;
            }
        }

        // Format metrics for display
        function formatNodeMetrics(metrics) {
            if (!metrics || metrics.length === 0) {
                return '<div class="metric-item"><span class="metric-name">No data</span></div>';
            }

            const priorityMetrics = ['cpu_percent', 'memory_percent', 'disk_percent', 'node_status'];
            const displayMetrics = metrics
                .filter(m => priorityMetrics.includes(m.name))
                .slice(0, 4);

            return displayMetrics.map(m => {
                const value = typeof m.value === 'number' ? m.value.toFixed(1) : m.value;
                return `
                    <div class="metric-item">
                        <div class="metric-name">${formatMetricName(m.name)}</div>
                        <div class="metric-value">${value}${m.unit || ''}</div>
                    </div>
                `;
            }).join('');
        }

        // Format metric name for display
        function formatMetricName(name) {
            const names = {
                'cpu_percent': 'CPU',
                'memory_percent': 'Memory',
                'disk_percent': 'Disk',
                'node_status': 'Status',
                'load_average': 'Load',
                'process_count': 'Processes'
            };
            return names[name] || name;
        }

        // Show node detail with chart
        async function showNode(clusterName, nodeName) {
            currentView = 'node';
            currentCluster = clusterName;
            currentNode = nodeName;
            updateBreadcrumb();

            const content = document.getElementById('content');
            content.innerHTML = '<div class="loading">Loading node details...</div>';

            try {
                const [nodeResponse, metricsListResponse] = await Promise.all([
                    fetch(`/api/clusters/${clusterName}/nodes/${nodeName}`),
                    fetch('/api/metrics/available')
                ]);

                const node = await nodeResponse.json();
                const availableMetrics = await metricsListResponse.json();

                if (node.error) {
                    content.innerHTML = `<div class="error-message">${node.error}</div>`;
                    return;
                }

                // Filter to numeric metrics only for charting
                const numericMetrics = availableMetrics.filter(m => 
                    ['cpu_percent', 'memory_percent', 'memory_used', 'disk_percent', 
                     'disk_used', 'network_bytes_recv', 'network_bytes_sent', 
                     'load_average', 'process_count'].includes(m.name)
                );

                let html = `
                    <div class="node-detail">
                        <div class="node-header" style="margin-bottom: 20px">
                            <div class="status-indicator status-${node.status_color}"></div>
                            <span class="cluster-name">${node.name}</span>
                            <span class="node-type" style="margin-left: 12px">${node.type}</span>
                        </div>
                        
                        <div class="node-info">
                            <div class="info-item">
                                <div class="info-label">Host</div>
                                <div class="info-value">${node.host}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Collection Method</div>
                                <div class="info-value">${node.collection_method}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Status</div>
                                <div class="info-value">${node.status}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Cluster</div>
                                <div class="info-value">${node.cluster_name}</div>
                            </div>
                        </div>

                        <h3 style="margin-bottom: 16px">Current Metrics</h3>
                        <div class="node-metrics" style="margin-bottom: 24px">
                            ${formatAllMetrics(node.metrics)}
                        </div>

                        <h3 style="margin-bottom: 16px">
                            Metric History
                            <div class="metric-selector" style="display: inline-block; margin-left: 16px">
                                <select id="metricSelect" onchange="loadMetricChart()">
                                    ${numericMetrics.map(m => `<option value="${m.name}">${formatMetricName(m.name)} (${m.unit || 'value'})</option>`).join('')}
                                </select>
                            </div>
                            <div class="time-range-selector">
                                <select id="timeRange" onchange="loadMetricChart()">
                                    <option value="1">Last 1 hour</option>
                                    <option value="6">Last 6 hours</option>
                                    <option value="24" selected>Last 24 hours</option>
                                    <option value="72">Last 3 days</option>
                                    <option value="168">Last 7 days</option>
                                </select>
                            </div>
                            <button class="refresh-btn" onclick="loadMetricChart()">Refresh</button>
                        </h3>
                        <div class="chart-container">
                            <canvas id="metricChart"></canvas>
                        </div>
                    </div>
                `;
                content.innerHTML = html;

                // Load initial chart
                loadMetricChart();
            } catch (error) {
                content.innerHTML = `<div class="error-message">Failed to load node: ${error.message}</div>`;
            }
        }

        // Format all metrics for detail view
        function formatAllMetrics(metrics) {
            if (!metrics || metrics.length === 0) {
                return '<div class="metric-item"><span class="metric-name">No data available</span></div>';
            }

            return metrics.map(m => {
                const value = typeof m.value === 'number' ? m.value.toFixed(2) : m.value;
                return `
                    <div class="metric-item">
                        <div class="metric-name">${formatMetricName(m.name)}</div>
                        <div class="metric-value">${value}${m.unit || ''}</div>
                    </div>
                `;
            }).join('');
        }

        // Load metric chart
        async function loadMetricChart() {
            const metricSelect = document.getElementById('metricSelect');
            const timeRange = document.getElementById('timeRange');
            
            if (!metricSelect || !timeRange) return;

            const metricName = metricSelect.value;
            const hours = timeRange.value;

            try {
                const response = await fetch(
                    `/api/clusters/${currentCluster}/nodes/${currentNode}/metrics?metric=${metricName}&hours=${hours}`
                );
                const data = await response.json();

                // Destroy existing chart
                if (chart) {
                    chart.destroy();
                }

                const ctx = document.getElementById('metricChart').getContext('2d');
                
                const labels = data.data.map(d => {
                    const date = new Date(d.timestamp);
                    return date.toLocaleString();
                });
                
                const values = data.data.map(d => d.value);

                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: formatMetricName(metricName),
                            data: values,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 2,
                            pointHoverRadius: 5
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Time'
                                },
                                ticks: {
                                    maxTicksLimit: 10
                                }
                            },
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: metricName.includes('percent') ? 'Percentage (%)' : 'Value'
                                },
                                beginAtZero: true
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Failed to load chart data:', error);
            }
        }

        // Update breadcrumb navigation
        function updateBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');
            let html = '<a href="#" onclick="showClusters()">Clusters</a>';

            if (currentCluster) {
                html += `<span>/</span><a href="#" onclick="showCluster('${currentCluster}')">${currentCluster}</a>`;
            }

            if (currentNode) {
                html += `<span>/</span><span>${currentNode}</span>`;
            }

            breadcrumb.innerHTML = html;
        }
    </script>
</body>
</html>
